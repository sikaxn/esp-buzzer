{% extends "base.html" %}

{% block title %}Projector{% endblock %}

{% block content %}
<div id="projector-container" style="
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  overflow: hidden;
">
<svg id="projectorSVG"
     viewBox="0 0 1920 1080"
     preserveAspectRatio="none"
     width="100%"
     height="100%"
     xmlns="http://www.w3.org/2000/svg">

    <defs>
      <pattern id="grid" width="120" height="120" patternUnits="userSpaceOnUse">
        <path d="M 120 0 H 0 V 120" fill="none" stroke="#2e90c9" stroke-width="2"/>
      </pattern>

      <style>
        .qmark {
          font-family: sans-serif;
          font-weight: bold;
          dominant-baseline: middle;
          text-anchor: middle;
          opacity: 0;
          transition: opacity 0.6s ease;
        }

        .qmark.visible {
          opacity: 1;
          animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
          0%   { transform: translateY(0px); }
          50%  { transform: translateY(-20px); }
          100% { transform: translateY(0px); }
        }

        #winnerDisplay {
          font-family: sans-serif;
          font-weight: bold;
          fill: white;
          text-anchor: middle;
          dominant-baseline: middle;
          font-size: 120px;
          opacity: 0;
          transition: opacity 0.5s ease;
        }

        #winnerDisplay.visible {
          opacity: 1;
        }
        #winnerButton {
        font-family: sans-serif;
        font-weight: bold;
        fill: #ffffffcc;
        text-anchor: middle;
        dominant-baseline: middle;
        font-size: 72px;
        opacity: 0;
        transition: opacity 0.5s ease;
      }

      #winnerButton.visible {
        opacity: 1;
      }

        #awaitingText {
          font-family: sans-serif;
          font-weight: bold;
          fill: #ffffffcc;
          text-anchor: middle;
          dominant-baseline: middle;
          font-size: 72px;
          opacity: 0;
          transition: opacity 0.5s ease;
        }

        #awaitingText.visible {
          opacity: 1;
        }
      </style>
    </defs>

    <!-- Background -->
    <rect width="100%" height="100%" fill="#12527a" />
    <rect width="100%" height="100%" fill="url(#grid)" />

    <!-- Question Marks (initially hidden) -->
    <g id="qGroup">
      <g transform="rotate(-15 400 300)"><text x="400" y="300" font-size="360" fill="#4fb4ff" class="qmark">?</text></g>
      <g transform="rotate(10 800 250)"><text x="800" y="250" font-size="400" fill="#2c88c9" opacity="0.75" class="qmark">?</text></g>
      <g transform="rotate(-8 1400 400)"><text x="1400" y="400" font-size="380" fill="#4fb4ff" opacity="0.6" class="qmark">?</text></g>
      <g transform="rotate(12 600 700)"><text x="600" y="700" font-size="350" fill="#4fb4ff" opacity="0.45" class="qmark">?</text></g>
      <g transform="rotate(-20 1000 800)"><text x="1000" y="800" font-size="420" fill="#2c88c9" opacity="0.85" class="qmark">?</text></g>
      <g transform="rotate(15 1600 300)"><text x="1600" y="300" font-size="390" fill="#4fb4ff" opacity="0.5" class="qmark">?</text></g>
      <g transform="rotate(-10 300 900)"><text x="300" y="900" font-size="360" fill="#4fb4ff" opacity="0.35" class="qmark">?</text></g>
      <g transform="rotate(18 1700 700)"><text x="1700" y="700" font-size="370" fill="#2c88c9" opacity="0.6" class="qmark">?</text></g>
    </g>

    <!-- Winner Display -->
    <text id="winnerDisplay" x="960" y="540"></text>
    <text id="winnerButton" x="960" y="650"></text>

    <!-- Awaiting Answer Text -->
    <text id="awaitingText" x="960" y="1000">Awaiting Answer...</text>
  </svg>
</div>
{% endblock %}

{% block scripts %}
<script>
const qmarks = Array.from(document.querySelectorAll('.qmark'));
const winnerText = document.getElementById('winnerDisplay');
const awaitingText = document.getElementById('awaitingText');
const winnerButton = document.getElementById('winnerButton');

// Audio setup
const preludeAudio = new Audio("{{ url_for('static', filename='sounds/prelude.mp3') }}");
const loopAudio = new Audio("{{ url_for('static', filename='sounds/loop.mp3') }}");
const winnerAudio = new Audio("{{ url_for('static', filename='sounds/winner.mp3') }}");

loopAudio.loop = true;

function stopAllAudio() {
  [preludeAudio, loopAudio, winnerAudio].forEach(audio => {
    audio.pause();
    audio.currentTime = 0;
  });
}

function clearVisuals() {
  qmarks.forEach(q => q.classList.remove('visible'));
  winnerText.classList.remove('visible');
  awaitingText.classList.remove('visible');
  winnerText.textContent = '';
  winnerButton.classList.remove('visible');
  winnerButton.textContent = '';
}

function animateQuestionMarks() {
  clearVisuals();
  awaitingText.classList.add('visible');
  qmarks.forEach((q, i) => {
    setTimeout(() => q.classList.add('visible'), i * 200);
  });
}

// Pre-authorize audio (required by most browsers)
document.addEventListener('click', () => {
  [preludeAudio, loopAudio, winnerAudio].forEach(a => {
    a.play().catch(() => {});
    a.pause();
  });
}, { once: true });

socket.on('projector_state', data => {
  if (data.state === 'clear') {
    clearVisuals();
    stopAllAudio();
  } else if (data.state === 'awaiting') {
    clearVisuals();
    stopAllAudio();
    animateQuestionMarks();

    preludeAudio.play().then(() => {
      preludeAudio.onended = () => {
        loopAudio.play().catch(err => console.warn("Loop play failed:", err));
      };
    }).catch(err => {
      console.warn("Prelude play failed:", err);
      loopAudio.play(); // Fallback
    });

  } else if (data.state === 'winner') {
    clearVisuals();
    stopAllAudio();
    winnerText.textContent = `Winner: ${data.name}`;
    winnerText.classList.add('visible');
    winnerButton.textContent = `Button ${data.button}`;
    winnerButton.classList.add('visible');
    winnerAudio.play();
  }
});
</script>
{% endblock %}
